on:
  workflow_call:
    inputs:
      PROJECT_ID:
        description: "The gcp project id"
        required: true
        type: string
      CONCURRENCY_GROUP:
        description: "The concurrency group"
        required: true
        type: string
      CANCEL_PREVIOUS_RUNS:
        description: "The concurrency group"
        required: true
        type: boolean
        default: true


jobs:
  push-build:
    strategy:
      matrix:
        ENVIRONMENT: ["dev-01", "dev-02", "dev-03", "staging", "production"] # Need restricted deployments, see environment
        PROJECT_ID: ["42"]
    name: Build push and deploy
    runs-on: ubuntu-latest
    environment: ${{ startsWith(matrix.ENVIRONMENT, 'dev-') && format('{0}-protected', matrix.ENVIRONMENT) || matrix.ENVIRONMENT }}
    concurrency:
      group: ${{ inputs.CONCURRENCY_GROUP }}
      cancel-in-progress: ${{ inputs.CANCEL_PREVIOUS_RUNS }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Build Push
        run: echo "Build and push stuff ${{ matrix.PROJECT_ID }}"
      - name: Deploy
        run: echo "Deploy by ${{ github.actor }}"