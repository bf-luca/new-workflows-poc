on:
  workflow_call:
    inputs:
      PROJECT_ID:
        required: true
        type: string

jobs:
  push-build:
    strategy:
      matrix:
        ENVIRONMENT: ["skip", "dev-01", "dev-02", "dev-03", "staging", "production"] # Need restricted deployments
        PROJECT_ID: ["42"]
      fail-fast: true
    name: Build push and deploy
    runs-on: ubuntu-latest
    environment: ${{ startsWith('dev-', matrix.ENVIRONMENT) && format('{0}-protected') || matrix.ENVIRONMENT }}
    steps:
      - name: Check Skip
        if: ${{matrix.ENVIRONMENT == 'skip'}}
        run: echo "You selected skipping the deployment" && exit 1
        continue-on-error: true
      - name: Skip everything
        if: failure()
        run: echo "Skipping build push"
      - name: Build Push
        if: success()
        run: echo "Build and push stuff ${{ matrix.PROJECT_ID }}"
        
  deploy-gke:
    needs: push-build
    runs-on: ubuntu-latest
    steps:
      - name: Deployment
        run: echo "Deploy"